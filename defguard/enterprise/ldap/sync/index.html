<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module contains the logic for synchronizing users and groups between Defguard and LDAP."><title>defguard::enterprise::ldap::sync - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../../static.files/rustdoc-916cea96.css"><meta name="rustdoc-vars" data-root-path="../../../../" data-static-root-path="../../../../static.files/" data-current-crate="defguard" data-themes="" data-resource-suffix="" data-rustdoc-version="1.87.0 (17067e9ac 2025-05-09)" data-channel="1.87.0" data-search-js="search-e7298875.js" data-settings-js="settings-d72f25bb.js" ><script src="../../../../static.files/storage-82c7156e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../../static.files/main-fb8c74a8.js"></script><noscript><link rel="stylesheet" href="../../../../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../../defguard/index.html">defguard</a><span class="version">1.3.2</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module sync</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#sync-status" title="Sync status">Sync status</a></li><li><a href="#full-synchronization" title="Full synchronization">Full synchronization</a></li><li><a href="#incremental-synchronization" title="Incremental synchronization">Incremental synchronization</a></li><li><a href="#potential-improvements-and-issues" title="Potential improvements and issues">Potential improvements and issues</a></li></ul><h3><a href="#enums">Module Items</a></h3><ul class="block"><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In defguard::<wbr>enterprise::<wbr>ldap</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../../index.html">defguard</a>::<wbr><a href="../../index.html">enterprise</a>::<wbr><a href="../index.html">ldap</a></div><h1>Module <span>sync</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../../src/defguard/enterprise/ldap/sync.rs.html#1-1560">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module contains the logic for synchronizing users and groups between Defguard and LDAP.</p>
<p>The synchronization is performed in two variants: full and incremental.</p>
<h2 id="sync-status"><a class="doc-anchor" href="#sync-status">§</a>Sync status</h2>
<p>The sync status is stored in the database and can be either <code>InSync</code> or <code>OutOfSync</code>. The status is used to determine
whether the full sync should be performed or not. The status is set to <code>OutOfSync</code> when some Defguard changes
couldn’t be propagated to LDAP (e.g. LDAP outage). The status is set to <code>InSync</code> when the sync is completed successfully.</p>
<h2 id="full-synchronization"><a class="doc-anchor" href="#full-synchronization">§</a>Full synchronization</h2>
<p>The full synchronization takes all objects (users, groups and their memberships) from one source,
compares it with the other one and computes appropriate changes to make the two sources roughly equal.</p>
<p>The full sync is performed only when the sync status is set to <code>OutOfSync</code>.</p>
<p>The changes are computed with regard to a specified authority, which determines which source is considered to
be the more important one and which is expected to be edited more often. The authority can be either LDAP or Defguard.</p>
<p>The authority has been introduced to solve the problem of ambiguity when some object is not present in one of the sources.
Such scenario may occur when a user is deleted from one of the sources OR when a user is added to one of the sources.
In each case, a different action should be taken to make the two sources equal (deletion or addition). For example:</p>
<ul>
<li>User is not present in LDAP but is present in Defguard</li>
<li>Did we just add the user to Defguard but couldn’t propagate that change or did we delete the user from LDAP?</li>
<li>If the authority is LDAP, we should delete the user from Defguard, as we assume that it was more probable that the change was made in LDAP.</li>
<li>If the authority is Defguard, we should add the user to LDAP, as we assume that it was more probable that the change was made in Defguard.</li>
</ul>
<p>If the LDAP connection is never lost and no other issues arise, the full sync should be performed only once, when the LDAP sync is enabled.
So this is a more of a damage control mechanism rather than something that should be invoked regularly.</p>
<h2 id="incremental-synchronization"><a class="doc-anchor" href="#incremental-synchronization">§</a>Incremental synchronization</h2>
<p>The incremental synchronization is a regular synchronization operation which comes in two varieties: synchronous and asynchronous.</p>
<p>Changes from Defguard are propagated to LDAP in real-time, synchronously, to keep LDAP up-to-date with Defguard instantly. This is done by
calling appropriate LDAP operations after each change in Defguard. Changes other way around (from LDAP to Defguard) are pulled asynchronously
at regular intervals (every 5 minutes by default). Implementation-wise it’s done by running a full sync with LDAP authority, as it has the same effect
when we consider that LDAP has the most recent Defguard changes (due to synchronous change propagation).</p>
<p>This synchronization should work reliably most of the time, given that:</p>
<ul>
<li>LDAP connection is stable</li>
<li>The LDAP change pull is performed relatively often</li>
<li>One object is not changed in both sources between two asynchronous syncs (may cause overwriting of changes), but this sounds like an unlikely scenario</li>
</ul>
<h2 id="potential-improvements-and-issues"><a class="doc-anchor" href="#potential-improvements-and-issues">§</a>Potential improvements and issues</h2>
<ul>
<li>Some optimizations could be made using the implementation-specific object modification/creation timestamps in LDAP. Currently everything is compared
as is, without any regard to the time of the change. We could skip some operations on objects that haven’t changed since the last sync. There is however
still an issue with objects that have been deleted, LDAP doesn’t store deleted objects by default, so we may still need to compare full object lists.</li>
<li>There is no real pagination and everything is loaded into the memory at once. This may be an issue at some point. 10k LDAP records wasn’t a problem in testing.
We may have bigger issues with other parts of Defguard with that user count though.</li>
</ul>
</div></details><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><dl class="item-table"><dt><a class="enum" href="enum.Authority.html" title="enum defguard::enterprise::ldap::sync::Authority">Authority</a></dt><dt><a class="enum" href="enum.SyncStatus.html" title="enum defguard::enterprise::ldap::sync::SyncStatus">Sync<wbr>Status</a></dt></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.get_ldap_sync_interval.html" title="fn defguard::enterprise::ldap::sync::get_ldap_sync_interval">get_<wbr>ldap_<wbr>sync_<wbr>interval</a></dt><dt><a class="fn" href="fn.get_ldap_sync_status.html" title="fn defguard::enterprise::ldap::sync::get_ldap_sync_status">get_<wbr>ldap_<wbr>sync_<wbr>status</a></dt><dt><a class="fn" href="fn.is_ldap_desynced.html" title="fn defguard::enterprise::ldap::sync::is_ldap_desynced">is_<wbr>ldap_<wbr>desynced</a></dt><dt><a class="fn" href="fn.set_ldap_sync_status.html" title="fn defguard::enterprise::ldap::sync::set_ldap_sync_status">set_<wbr>ldap_<wbr>sync_<wbr>status</a></dt></dl></section></div></main></body></html>